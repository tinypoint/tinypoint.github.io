---
layout:     post
title:      面试必考的跨域问题你还是不会？别怕，这里有最全的总结！！！
subtitle:   最全跨域方案总结
date:       2017-09-28
author:     tinypoint
header-img: img/post-bg-2015.jpg
catalog: true
tags:
    - 前端
    - 跨域
    - 面试
---

> 本文首次发布于 [tinypoint\`s blog](http://tinypoint.github.io), 作者 [@张小点(tinypoint)](http://github.com/tinypoint) ,转载请保留原文链接.

# 前言

最近正是招聘季节，面试前端的小伙伴们难免会在**跨域问题**上被面试官们'刁难'，不过别怕，这篇文章将会详细的讲解常用的跨域解决方案，帮你在面试中披荆斩棘。

# 正文

通过XHR实现AJAX通信的一个主要限制，来源于跨域安全策略。默认情况下XHR对象只能访问与包含它的页面位于同一个域中的资源，即**同源策略**。这种安全策略可以预防某些恶意行为。但是，实现合理的跨域请求对开发某些浏览器应用程序是至关重要的。

## 同源策略

同源是指
- 协议相同(FTP、HTTP等)
- 域名相同(包括每一级域名, domain.com和www.domain.com不同)
- 端口相同

不符合以上任意一条都不属于同源, 跨域的请求将会受到限制

### 解决方案


#### 所有具有src的标签

- 比如`<img>`，`<script>`，`<link>`
- 只能进行GET请求
- 需要注意的是img标签在设置src属性的时候就会进行发送请求，而link，script，iframe等则是在被添加到页面中才会发送请求
 

```javascript
var img = new Image()
img.onload = function () {
    console.log('成功加载');
}
img.src = 'http://www.example.com';

var script = document.createElement('script');
script.src = 'http://www.example.com'
document.body.appendChild(script);
```

#### jsonp

- jsonp其实利用了<script>标签可以跨域这一特性，而且可以在跨域脚本中直接回调当前脚本的函数。
- 回调函数必须是全局函数
- 同样，只能用于GET方法

```javascript
function dataResolver (data) {
    console.log('This is' + data);
}

var script = docuemnt.createElement('script');
script.src = 'http://www.example.com?callback=daraResolver'
docuemnt.body.appendChild(script);
```

#### document.domain

- 只适用于主域相同，子域不同的页面交流，如从`http://subdomain.domain.com`到`http://domain.com`之间的通信
- 原理：利用document.domain允许同时也是只允许从低级域名到高级域名设置，手动设置document的domain属性，让页面同域

例

```javascript
<script>
    //  http://domain.com/example 页面
    var iframe = document.createElement('iframe');
    iframe.src = 'http://subdomain.domain.com';
    
    iframe.onload = function() {
        var iframeDocuemnt = iframe.contentDocument || iframe.contentWindow.document;
        alert(iframeDocuemnt.getElementById("foo").innerHTML));
    };
    
    iframe.style.display = 'none';
    document.body.appendChild(iframe);
<script>
```

设置document.domain与父页面保持一致

```javascript
<script>
    //  http://subdomain.domain.com/example 页面
    document.domain = 'domain.com';
</script>
```

#### window.name跨域

- 在一个窗口(window)的生命周期内,窗口载入的所有的页面共享一个window.name的，每个页面对window.name都有读写的权限
- window支持多达`2m`的name属性
 
当`a.com/index.html`要从`b.com/data.html`获取数据时，需要借助与a同域的`a.com/proxy.html`作为代理

`a.com/index.html` 

```javascript
// load事件会触发两次，每个时机都有不同的任务
var proxy = function (url, cb) {
    var isFirst = true;
    
    var iframe = document.createElement('iframe');
    iframe.src = url;
    
    iframe.onload = function () {
        if (isFirst) {
            // 切换到代理页面
            iframe.contentWindow.location = 'http://a.com/proxy.html';
            isFirst = false
        } else {
            // 读取window.name
            cb(iframe.contentWindow.name);
            destoryFrame();
        }
    }
}

// iframe用完要删除，释放内存，同时保证了安全
function destoryFrame () {
    iframe.contentWindow.document.write('');
    iframe.contentWindow.close();
    document.bosy.removeChild(iframe);
}

//想要发送数据，可以将数据放在window.name中

window.name = '12';

proxy('http://b.com/data.html', function (data) {
    console.log(data);
});
```
`a.com/proxy.html`代理页面与主页面同域，内容为空即可

`b.com/data.html`

```javascript
var id = window.name;
window.name = id + 'is tinypoint';
```
