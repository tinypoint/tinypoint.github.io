---
layout:     post
title:      前端性能优化，YaHoo!军规35条
subtitle:   由YaHoo!团队总结的前端性能优化35条建议
date:       2017-10-02
author:     tinypoint
header-img: img/YaHoo!.jpg
catalog: true
tags:
    - 前端
    - javascript
    - 性能优化
    - 面试
---

> 本文首次发布于 [tinypoint\`s blog](http://tinypoint.github.io), 作者 [@张小点(tinypoint)](http://github.com/tinypoint) ,转载请保留原文链接.


### 内容部分


#### 1.尽量减少HTTP请求

80%的终端用户响应时间都花在了前端上，其中大部分时间都在下载页面上的各种资源：图片，样式表，脚本，Flash等等。减少资源数必然能够减少页面提交的HTTP请求数。

- **合并文件**,包括将脚本文件合并成一个脚本，合并css文件等
- **css sprites**,将本惊图片整合到一张图片中，使用的时候，使用background-position进行定位
    - 可以使用CssGaga工具合成雪碧图
    - 还可以使用gulp，webpack，这两个都需要用到spritesmith的插件  
- **图片映射**, 可以把多张图片合并成单张图片，总大小是一样的，但减少了请求数并加速了页面加载。图片映射只有在图像在页面中连续的时候才有用，比如导航条。给image map设置坐标的过程既无聊又容易出错，用image map来做导航也不容易，所以不推荐用这种方式。
- **图片转成base64格式（行内图片）**，base64是一种网络上常用的8bit字节代码的编码方式，base64可以用于http环境下传递较长的标识信息，同时可以放在url当中使用。
将图片转换成base64代码可以减少http请求，因为图片可以以字符编码的形式直接传递到客户端，文件形式需要进行http请求（加重了html，但是减少了http请求）。但是图片编码化base64的时候大小会变大，但是通过gzip优化以后基本差不多。所以适合较小的图片直接编码成base64，较大的图片则不建议。[*html5将图片转换成base64代码*
](http://www.jianshu.com/p/90fc1f9042a8)中讲解了html5如何将图片转换成base64。

以上都是为了减少HTTP请求

#### 2.减少DNS查找

在浏览器地址栏输入网址后，浏览器需要通过DNS查询得到网站真实IP。而查找的是需要成本的。

DNS查询应该被缓存以提高性能。可以缓存在特定的缓存服务器（ISP/local area network维护），也可以是用户的计算机。DNS信息留存在操作系统DNS缓存中（在windows中就是 DNS Client Serve ）。大多浏览器也会有有自己的缓存，独立于操作系统缓存。只要浏览器在自己的缓存里有某条DNS记录，它就不会向操作系统发DNS解析请求。

减少DNS请求数可会减少并行下载数。避免DNS查找减少响应时间，但减少并行下载数可能会增加响应时间。指导原则是组件可以分散在至少2个但不多于4个的不同域名。这是两者的妥协。

#### 3.避免跳转

跳转用301或302状态码来达成。一个301响应http头的例子：


```
HTTP/1.1 301 Moved Permanently
Location: http://example.com/newuri
Content-Type: text/html
```

浏览器自动跳转到Location指定的路径。跳转所需的所有信息都在http头，所以http主体一般是空的。301 302响应一般不会被缓存，除非有额外的头部信息，比如Expires或Cache-Control指定要缓存。meta刷新标签或 JavaScript 也可以跳转，但如果真要跳转，3xx跳转更好，主要是保证返回键可用。

跳转显然拖慢响应速度。在跳转的页面被获取前浏览器没什么能渲染，没什么组件能下载。

最浪费的跳转之一发生在url尾部slash（/）缺失。比如http://astrology.yahoo.com/astrology会301跳转到http://astrology.yahoo.com/astrology/。这可以被Apache等服务器修复，用Alias，mod_rewrite等等。


#### 4.让Ajax可缓存

动态创建的Ajax响应是可以被缓存的，通过设置Expires或者Cache-Control HTTP头可以将未过期或者未更改的资源被缓存起来，以提高性能。另外,还有的其它方法是：
- gzip压缩
- 减少DNS查找
- 压缩JS
- 避免跳转
- 设置ETags


#### 5.延迟加载组件

看看你的页面然后问问自己，“什么是页面初始化必须的？”。剩下的内容和组件可以延迟。

JavaScript是理想的（延迟）候选者，可以切分到onload事件之前和之后。比如拖放的js库可以延迟，因为拖动必须在页面初始化之后。其它可延迟的包括隐藏的内容，折叠起来的图片等等。

#### 6.预加载组件

预加载看起来与延迟加载相反，但它的确有个不同的目标。通过预加载你可以利用浏览器的空闲时间来请求你将来会用到的组件。这样当用户访问下一个页面时，你会有更多的组件已经在缓存中，这样会极大加快页面加载。

有几种预加载类型：

无条件预加载：一旦onload触发，你立即获取另外的组件。比如谷歌会在主页这样加载搜索结果页面用到的雪碧图。
有条件预加载：基于用户动作，你推测用户下一步会去哪里并加载相应组件。
预期的预加载：在发布重新设计（的网站）前提前加载。在旧网页预加载新网页的部分组件，那么切换到新网页时就不会是没有任何缓存了。

#### 7.减少DOM数

一个复杂的页面意味着更多的内容要下载，以及更慢的dom访问。比如在有500dom数量的页面添加事件处理就和有5000dom数量的不同。

如果你的页面dom元素很多，那么意味着你可能需要删除无用的内容和标签来优化。

#### 8.把组件分散到不同的域名

把组件分散到不同的域名允许你最大化并行下载数。由于DNS查询的副作用，最佳的不同域名数是2-4。

#### 9.最小化iframe的数量。

iframe允许html文档被插入到父文档。

`<iframe>`优点
- 帮助解决缓慢的第三方内容的加载，如广告和徽章
- 安全沙盒
- 并行下载脚本

`<iframe>`缺点
- 成本高（资源和时间），即使是一个空的iframe
- 阻塞了页面的onload（最好是使用js动态添加）
- 非语义化（不利于SEO）

#### 10.不要404

http请求是昂贵的，所以发出http请求但获得没用的响应（如404）是完全不必要的，并且会降低用户体验。

一些网站会有特别的404页面提高用户体验，但这仍然会浪费服务器资源。特别坏的是当链接指向外部js但却得到404结果。这样首先会降低（占用）并行下载数，其次浏览器可能会把404响应体当作js来解析，试图从里面找出可用的东西。

### CSS部分


#### 1.把样式放在顶部

研究雅虎网页性能时发现把样式表移到<head>里会让页面更快。这是因为把样式表移到<head>里允许页面逐步渲染。

关注性能的前端工程师希望页面被逐步渲染，这时因为，我们希望浏览器尽早渲染获取到的任何内容。这对大页面和网速慢的用户很重要。给用户视觉反馈，比如进度条的重要性已经被大量研究和记录。在我们的情况中，HTML页面就是进度条。当浏览器逐步加载页面头部，导航条，logo等等，这些都是给等待页面的用户的视觉反馈。这优化了整体用户体验。

把样式表放在文档底部的问题是它阻止了许多浏览器的逐步渲染，包括IE。这些浏览器阻止渲染来避免在样式更改时需要重绘页面元素。所以用户会卡在白屏。

HTML规范清楚表明样式应该在<head>里。

> 参考
> - [Best Practices for Speeding Up Your Web Site](https://developer.yahoo.com/performance/rules.html)
> - [雅虎前端优化35条规则翻译](https://github.com/creeperyang/blog/issues/1)
> - [【原】雅虎前端优化的35条军规
](http://www.cnblogs.com/xianyulaodi/p/5755079.html)
> - [html5将图片转换成base64代码
](http://www.jianshu.com/p/90fc1f9042a8)

